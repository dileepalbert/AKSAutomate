tenantId=""
subscriptionId=""
resourceGroup=""
objectId=""

az login --tenant $tenantId

az bicep install
az bicep upgrade
az bicep decompile -f <file_name>

PreConfig
=========
vnetName="aks-k8s-vnet"
vnetPrefix="25.0.0.0/21"
aksSubnetName="aks-k8s-subnet"
aksSubnetPrefix="25.0.0.0/24"
ingressSubnetName="aks-k8s-ingress-subnet"
ingressSubnetPrefix="25.0.1.0/24"
appgwSubnetName="appgw-subnet"
appgwSubnetPrefix="25.0.2.0/27"
masterVnetName="master-workshop-vnet"
masterResourceGroup="master-workshop-rg"

acrName="aksk8sacr"
keyVaultName="aks-k8s-kv"

az deployment group create -f ./preconfig.bicep -g $resourceGroup \
--parameters vnetName=$vnetName vnetPrefix=$vnetPrefix \
aksSubnetName=$aksSubnetName aksSubnetPrefix=$aksSubnetPrefix \
ingressSubnetName=$ingressSubnetName ingressSubnetPrefix=$ingressSubnetPrefix \
appgwSubnetName=$appgwSubnetName appgwSubnetPrefix=$appgwSubnetPrefix \
acrName=$acrName keyVaultName=$keyVaultName objectId=$objectId


Setup
=====
clusterName='aks-k8s-cluster'
location='eastus'
kubernetesVersion='1.19.11'
vmSize='Standard_DS2_V2'
osType='Linux'
osSKU='Ubuntu'
vmType='VirtualMachineScaleSets'
vnetName='aks-k8s-vnet'
aksSubnetName='aks-k8s-subnet'
nodePoolMode='System'
nodePoolName='syspool'
nodeResourceGroup='aks-k8s-noderg'
serviceCidr='25.0.3.0/24'
dnsServiceIP='25.0.3.10'
clientId="3aa80634-c5e7-4415-8219-bef6ffecb908"
clientSecret="KgDIbqNoxPz~nR~8vj8AcGtQr-TWg.rDHc"
aadTenantId='3851f269-b22b-4de6-97d6-aa9fe60fe301'
adminGroupObjectIDs='["6ec3a0a8-a6c6-4cdf-a6e3-c296407a5ec1"]'
sysNodeCount=3
maxPods=50
maxCount=10
minCount=2
enableAutoScaling=true
enablePrivateCluster=false
logWorkspaceName='aks-workshop-lw'
lwResourceGroup='monitoring-workshop-rg'

SP role assignment
===================
vnetSubNetId=$(az network vnet subnet show -n $aksSubnetName --vnet-name $vnetName -g $resourceGroup --query="id" -o tsv)
az role assignment create --role='Network Contributor' --assignee=3aa80634-c5e7-4415-8219-bef6ffecb908 --scope=$vnetSubNetId
========

Log Workspace ID
=================
logWorkspaceId=$(az monitor log-analytics workspace show -n $logWorkspaceName -g $lwResourceGroup --query="id" -o tsv)
=======

az deployment group create -f ./setup.bicep -g $resourceGroup \
--parameters clusterName=$clusterName location=$location \
kubernetesVersion=$kubernetesVersion vmSize=$vmSize \
osType=$osType osSKU=$osSKU vmType=$vmType \
vnetName=$vnetName aksSubnetName=$aksSubnetName \
nodePoolMode=$nodePoolMode nodePoolName=$nodePoolName \
nodeResourceGroup=$nodeResourceGroup \
serviceCidr=$serviceCidr dnsServiceIP=$dnsServiceIP \
clientId=$clientId clientSecret=$clientSecret \
aadTenantId=$aadTenantId adminGroupObjectIDs=$adminGroupObjectIDs \
sysNodeCount=$sysNodeCount maxPods=$maxPods \
maxCount=$maxCount minCount=$minCount logWorkspaceId=$logWorkspaceId \
enableAutoScaling=$enableAutoScaling enablePrivateCluster=$enablePrivateCluster

az aks get-credentials -g $resourceGroup -n $clusterName --admin
az aks delete -g $resourceGroup -n $clusterName --yes

